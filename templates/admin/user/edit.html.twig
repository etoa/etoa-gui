{% extends 'admin/layout/admin.html.twig' %}

{% block content %}
    <script type="text/javascript">
        function loadSpecialist(st) {
            const elem = document.getElementById('user_specialist_id');
            xajax_showTimeBox('spt', 'user_specialist_time', st, elem.options[elem.selectedIndex].value);
        }

        function loadAllianceRanks(val) {
            const elem = document.getElementById('user_alliance_id');
            xajax_allianceRankSelector('ars', 'user_alliance_rank_id', val, elem.options[elem.selectedIndex].value);
        }

        function toggleText(elemId, switchId) {
            if (document.getElementById(switchId).innerHTML === 'Anzeigen') {
                document.getElementById(elemId).style.display = '';
                document.getElementById(switchId).innerHTML = 'Verbergen';
            } else {
                document.getElementById(elemId).style.display = 'none';
                document.getElementById(switchId).innerHTML = 'Anzeigen';
            }
        }
    </script>

    <h1>Spieler</h1>
    <h3>User bearbeiten: {{ user.nick }}</h3>

    <form action="{{ path('admin.users.edit', {id: user.id}) }}" method="post">
        <input type="hidden" id="tabactive" name="tabactive" value=""/>
        <div class="tabs" id="user_edit_tabs">
            <ul>
                <li><a href="#tabs-1">Info</a></li>
                <li><a href="#tabs-2">Account</a></li>
                <li><a href="#tabs-3">Daten</a></li>
                <li><a href="#tabs-4">Sitting</a></li>
                <li><a href="#tabs-5">Profil</a></li>
                <li><a href="#tabs-6">Design</a></li>
                <li><a href="#tabs-7">Nachrichten</a></li>
                <li><a href="#tabs-8">Loginfehler</a></li>
                <li><a href="#tabs-9">Punkte</a></li>
                <li><a href="#tabs-10">Tickets</a></li>
                <li><a href="#tabs-11">Kommentare</a></li>
                <li><a href="#tabs-12">Log</a></li>
                <li><a href="#tabs-13">Wirtschaft</a></li>
            </ul>

            {# Allgemeines #}
            <div id="tabs-1">
                <table class="tbl">
                    <tr>
                        <td class="tbltitle" style="width:180px;">ID:</td>
                        <td class="tbldata">{{ user.id }}</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Registrierdatum:</td>
                        <td class="tbldata">{{ formatTimestamp(user.registered) }}</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Zuletzt online:</td>
                        {% if user.timeAction != null %}
                            <td class="tbldata" style="color:#0f0;">online</td>
                        {% elseif user.timeLog > 0 %}
                            <td class="tbldata">{{ formatTimestamp(user.timeLog) }}</td>
                        {% else %}
                            <td class="tbldata">Noch nicht eingeloggt!</td>
                        {% endif %}
                    </tr>
                    <tr>
                        <td class="tbltitle">IP/Host:</td>
                        <td class="tbldata">
                            <a href="{{ path('admin.users.ips') }}?ip={{ user.ipAddr }}">{{ user.ipAddr }}</a>
                            <a href="{{ path('admin.users.ips') }}?host={{ host }}">{{ host }}</a>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Agent:</td>
                        <td class="tbldata">{{ agent }}</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Punkte:</td>
                        <td class="tbldata">
                            {{ formatNumber(user.points) }}
                            [<a href="javascript:" onclick="toggleBox('pointGraph')">Verlauf anzeigen</a>]
                            <div id="pointGraph" style="display:none;">
                                <img src="{{ path('admin.images.stats', {user: user.id}) }}" alt="Diagramm"/>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Rang:</td>
                        <td class="tbldata">
                            {{ formatNumber(user.rank) }} (aktuell),
                            {{ formatNumber(user.rankHighest) }} (max)
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Rohstoffe von...</td>
                        <td class="tbldata">
                            Raids: {{ formatNumber(user.resFromRaid) }} t<br/>
                            Asteroiden: {{ formatNumber(user.resFromAsteroid) }} t<br/>
                            Nebelfelder: {{ formatNumber(user.resFromNebula) }} t<br/>
                            Trümmerfelder: {{ user.resFromTf }} t
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Infos:</td>
                        <td class="tbldata">
                            {% if user.observe != '' %}
                                <div>
                                    Benutzer steht unter <b>Beobachtung</b>: {{ user.observe }} &nbsp;
                                    [<a href="{{ path('admin.users.observer.details', {id: user.id}) }}">Ändern</a>]
                                </div>
                            {% endif %}
                            {% if user.deleted != 0 %}
                                <div class="userDeletedColor">Dieser Account ist zur Löschung
                                    am {{ formatTimestamp(user.deleted) }} vorgemerkt
                                </div>
                            {% endif %}
                            {% if user.hmodFrom > 0 %}
                                <div class="userHolidayColor">Dieser Account ist im Urlaubsmodus
                                    seit {{ formatTimestamp(user.hmodFrom) }} bis
                                    mindestens {{ formatTimestamp(user.hmodTo) }}
                                </div>
                            {% endif %}
                            {% if isBlocked %}
                                <div class="userLockedColor">
                                    Dieser Account ist im gesperrt von {{ formatTimestamp(user.blockedFrom) }}
                                    bis {{ formatTimestamp(user.blockedTo) }}.
                                    {% if user.banReason != '' %}Grund: {{ user.banReason }}{% endif %}
                                </div>
                            {% endif %}
                            {% if user.admin != 0 %}
                                <div class="adminColor">Dies ist ein Admin-Account!</div>
                            {% endif %}
                            {% if user.ghost %}
                                <div class="userGhostColor">
                                    Dies ist ein Geist-Account. Er wird nicht in der Statistik angezeigt!
                                </div>
                            {% endif %}
                            {% if user.chatAdmin != 0 %}
                                <div>Dieser User ist ein Chat-Admin.</div>
                            {% endif %}
                            {% if user.verificationKey != '' %}
                                <div>
                                    Die E-Mail Adresse ist noch nicht bestätigt
                                    [<a href="{{ path('admin.users.set_verified', {id: user.id}) }}">Freischalten</a>].
                                </div>
                            {% endif %}

                            {# Kommentare #}
                            {% if comments.count > 0 %}
                                <div>
                                    <b>{{ comments.count }}Kommentare</b> vorhanden, neuster Kommentar
                                    von {{ formatTimestamp(comments.latest) }}
                                    [<a href="javascript:" onclick="$('.tabs').tabs('select', 10);">Zeigen</a>]
                                </div>
                            {% endif %}

                            {# Tickets #}
                            {% if numberOfNewTickets + numberOfAssignedTickets > 0 %}
                                <div>
                                    <b>{{ numberOfNewTickets }} neue Tickets</b> und <b> {{ numberOfAssignedTickets }}
                                        zugewiesene Tickets</b> vorhanden.
                                    [<a href="javascript:" onclick="$('.tabs').tabs('select', 9);">Zeigen</a>]
                                </div>
                            {% endif %}

                            {# Verwarnungen #}
                            {% if warning.count > 0 %}
                                <div>
                                    <b>{{ warning.count }} Verwarnungen</b> vorhanden, neuste
                                    von {{ formatTimestamp(warning.max) }}.
                                    [<a href="{{ path('admin.users.warnings') }}">Zeigen</a>]
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>

            {# Account #}
            <div id="tabs-2">
                <table class="tbl">
                    <tr>
                        <td class="tbltitle"><label for="user_nick">Nick:</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_nick" id="user_nick" value="{{ user.nick }}" size="35"
                                   maxlength="250"/>
                        </td>
                        <td>Eine Nickänderung ist grundsätzlich nicht erlaubt</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_email">E-Mail:</label></td>
                        <td class="tbldata">
                            <input type="email" name="user_email" id="user_email" value="{{ user.email }}" size="35"
                                   maxlength="250"/>
                        </td>
                        <td>Rundmails gehen an diese Adresse</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_name">Name:</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_name" id="user_name" value="{{ user.name }}" size="35"
                                   maxlength="250"/>
                        </td>
                        <td>Bei Accountübergabe anpassen</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_email_fix">E-Mail fix:</label></td>
                        <td class="tbldata">
                            <input type="email" name="user_email_fix" id="user_email_fix"
                                   value={{ user.emailFix }} size="35" maxlength="250"/>
                        </td>
                        <td>Bei Accountübergabe anpassen</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="dual_name">Name Dual:</label></td>
                        <td class="tbldata">
                            <input type="text" name="dual_name" id="dual_name" value="{{ user.dualName }}" size="35"
                                   maxlength="250"/>
                        </td>
                        <td>Bei Dualänderung anpassen</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="dual_email">E-Mail Dual:</label></td>
                        <td class="tbldata">
                            <input type="email" name="dual_email" id="dual_email" value="{{ user.dualEmail }}" size="35"
                                   maxlength="250"/>
                        </td>
                        <td>Bei Dualänderung anpassen</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_password">Passwort:</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_password" id="user_password" value="" size="35"
                                   maxlength="250"/>
                        </td>
                        <td>Leerlassen um altes Passwort beizubehalten</td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_password_temp">Temporäres Passwort:</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_password_temp" id="user_password_temp"
                                   value="{{ user.passwordTemp }}" size="30" maxlength="30"/>
                        </td>
                        <td>Nur dieses wird verwendet, falls ausgefüllt</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Geist:</td>
                        <td class="tbldata">
                            {% set ghostOptions = { 1: 'Ja', 0: 'Nein' } %}
                            {{ component('forms:radio_button_list', { name: 'user_ghost', options: ghostOptions, value: user.ghost ? 1 : 0 }) }}
                        </td>
                        <td>Legt fest ob der Spieler in der Rangliste ausgeblendet wird</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Chat-Admin:</td>
                        <td class="tbldata">
                            {% set chatAdmin = { 1: 'Ja', 0: 'Nein', 2: 'Leiter Team Community', 3: 'Entwickler mit Adminrechten' } %}
                            {{ component('forms:radio_button_list', { name: 'user_chatadmin', options: chatAdmin, value: user.chatAdmin }) }}
                        </td>
                        <td>Der Spieler hat Adminrechte im Chat und einen silbernen Stern für Chatadmin,
                            einen grünen Stern für Leiter Team Community bzw. einen cyanfarbenen Stern für
                            Entwickler mit Adminrechten (Entwickler mit Adminrechten funktioniert nur, wenn unten
                            'Admin' auf 'Ja' gestellt wird).
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Admin:</td>
                        <td class="tbldata">
                            {% set adminOptions = { 1: 'Ja', 0: 'Nein', 2: 'Entwickler ohne Adminrechte' } %}
                            {{ component('forms:radio_button_list', { name: 'admin', options: adminOptions, value: user.admin }) }}
                        </td>
                        <td>
                            Admin: Der Spieler wird in der Raumkarte als Game-Admin markiert.<br/>
                            Entwickler: Der Spieler bekommt einen nutzlosen roten Stern im Chat, keine Markierung
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">NPC:</td>
                        <td class="tbldata">
                            {% set npcOptions = { 1: 'Ja', 0: 'Nein' } %}
                            {{ component('forms:radio_button_list', { name: 'npc', options: npcOptions, value: user.npc }) }}
                        </td>
                        <td>Spieler wird als NPC markiert</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Sperren</td>
                        <td class="tbldata">
                            {% set banOptions = { 0: 'Nein', 1: 'Ja' } %}
                            {{ component('forms:radio_button_list', { name: 'ban_enable', options: banOptions, value: user.blockedFrom > 0 ? 1 : 0 }) }}
                            {#                            onclick="$('#ban_options').hide();" #}
                            {#                            onclick="$('#ban_options').show();" #}
                            {% if isNoLongerBlocked %}<i><b>Diese Sperre ist abgelaufen!</b></i>{% endif %}
                            <table id="ban_options">
                                <tr>
                                    <td class="tbltitle"><label for="user_blocked_from">Von</label></td>
                                    <td class="tbldata">
                                        {{ component('forms:date_time_input', { name: 'user_blocked_from', value: user.blockedFrom > 0 ? user.blockedFrom : date().timestamp }) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tbltitle"><label for="user_blocked_to">Bis</label></td>
                                    <td class="tbldata">
                                        {{ component('forms:date_time_input', { name: 'user_blocked_to', value: user.blockedFrom > 0 ? user.blockedTo : userBlockedDefaultTime }) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tbltitle"><label for="user_ban_admin_id">Admin</label></td>
                                    <td class="tbldata">
                                        {{ component('forms:select_input', { name: 'user_ban_admin_id', options: adminUserNicks, value: user.banAdminId, emptyValue: 0, emptyLabel: '(niemand)' }) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tbltitle"><label for="user_ban_reason">Grund</label></td>
                                    <td class="tbldata">
                                        <textarea name="user_ban_reason" id="user_ban_reason" cols="45"
                                                  rows="2">{{ user.banReason }}</textarea>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>Der Benutzer kann sich nicht einloggen und erscheint auf dem Pranger</td>
                    </tr>
                    <tr>
                        <td class="tbltitle">U-Mod</td>
                        <td class="tbldata">
                            {% set umodOptions = { 0: 'Nein', 1: 'Ja' } %}
                            {{ component('forms:radio_button_list', { name: 'umod_enable', options: umodOptions, value: user.hmodFrom > 0 ? 1 : 0 }) }}
                            {#                                   onclick="$('#umod_options').hide();" #}
                            {#                                   onclick="$('#umod_options').show();" #}
                            {% if holidayModeExpired %}<i><b>Dieser Urlaubsmodus ist abgelaufen!</b></i>{% endif %}
                            <table id="umod_options">
                                <tr>
                                    <td class="tbltitle"><label for="user_hmode_from">Von</label></td>
                                    <td class="tbldata">
                                        {{ component('forms:date_time_input', { name: 'user_hmode_from', value: user.hmodFrom > 0 ? user.hmodFrom : date().timestamp }) }}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tbltitle"><label for="user_hmode_to">Bis</label></td>
                                    <td class="tbldata">
                                        {{ component('forms:date_time_input', { name: 'user_hmode_to', value: user.hmodTo > 0 ? user.hmodTo : userHolidayModeDefaultTime }) }}
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td>Der Benutzer kann nichts mehr bauen, wird aber auch nicht angegriffen</td>
                    </tr>
                </table>
            </div>

            {# Game-Daten #}
            <div id="tabs-3">
                <table class="tbl">
                    <tr>
                        <td class="tbltitle"><label for="user_race_id">Rasse:</label></td>
                        <td class="tbldata">
                            {{ component('forms:select_input', { name: 'user_race_id', options: raceNames, value: user.raceId, emptyValue: 0, emptyLabel: '(Keine)' }) }}
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_specialist_id">Spezialist:</label></td>
                        <td class="tbldata">
                            {{ component('forms:select_input', { name: 'user_specialist_id', options: specialistNames, value: user.specialistId, emptyValue: 0, emptyLabel: '(Keiner)' }) }}
                            {#  TODO onchange="loadSpecialist({{ $st }}" #}
                            Bis:nbsp; <span id="spt">-</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_alliance_id">Allianz:</label></td>
                        <td class="tbldata">
                            {{ component('forms:select_input', { name: 'user_alliance_id', options: allianceNamesWithTags, value: user.allianceId, emptyValue: 0, emptyLabel: '(Keine)' }) }}
                            {# TODO onchange="loadAllianceRanks({{ user.allianceRankId }});" #}
                            Rang: <span id="ars">-</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="spyship_count">Spionagesonden für Direktscan:</label></td>
                        <td class="tbldata">
                            {% if spyShipNames is not empty %}
                                <input type="text" name="spyship_count" id="spyship_count" maxlength="5" size="5"
                                       value="{{ properties.spyShipCount }}">
                                {{ component('forms:select_input', { name: 'spyship_id', options: spyShipNames, value: properties.spyShipId, emptyValue: 0, emptyLabel: '(keines)' }) }}
                            {% else %}
                                Momentan steht kein Schiff zur Auswahl!
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="analyzeship_count">Analysatoren für Quickanalyse:</label></td>
                        <td class="tbldata">
                            {% if analyzeShipNames is not empty %}
                                <input type="text" name="analyzeship_count" id="analyzeship_count" maxlength="5"
                                       size="5" value="{{ properties.analyzeShipCount }}">
                                {{ component('forms:select_input', { name: 'analyzeship_id', options: analyzeShipNames, value: properties.analyzeShipId, emptyValue: 0, emptyLabel: '(keines)' }) }}
                            {% else %}
                                Momentan steht kein Schiff zur Auswahl!
                            {% endif %}
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_alliace_shippoints">Verfügbare Allianzschiffteile</label>
                        </td>
                        <td class="tbldata">
                            <input type="text" name="user_alliace_shippoints" id="user_alliace_shippoints"
                                   value="{{ user.allianceShipPoints }}" size="10" maxlength="10"/>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_alliace_shippoints_used">Verbaute
                                Allianzschiffteile</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_alliace_shippoints_used" id="user_alliace_shippoints_used"
                                   value="{{ user.allianceShipPointsUsed }}" size="10" maxlength="10"/>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_multi_delets">Gelöschte Multis</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_multi_delets" id="user_multi_delets"
                                   value="{{ user.multiDelets }}" size="3"
                                   maxlength="3"/>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle"><label for="user_sitting_days">Sittertage</label></td>
                        <td class="tbldata">
                            <input type="text" name="user_sitting_days" id="user_sitting_days"
                                   value="{{ user.sittingDays }}" size="3" maxlength="3"/>
                        </td>
                    </tr>
                    <tr>
                        <td class="tbltitle">Hauptplanet geändert</td>
                        <td class="tbldata">
                            {% set ghostOptions = { 1: 'Ja', 0: 'Nein' } %}
                            {{ component('forms:radio_button_list', { name: 'user_changed_main_planet', options: ghostOptions, value: user.userChangedMainPlanet ? 1 : 0 }) }}
                        </td>
                    </tr>
                </table>
                <script type="text/javascript">
                    {# TODO loadSpecialist({{ $st }}); #}
                    loadAllianceRanks({{ user.allianceRankId }});
                </script>
            </div>

        </div>
    </form>
{% endblock %}

